-- A. Database Building
DROP DATABASE IF EXISTS apartment_for_rent;
CREATE DATABASE IF NOT EXISTS apartment_for_rent;
USE apartment_for_rent;

-- main types 

CREATE TABLE IF NOT EXISTS tenant (
    tenant_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    age INT NOT NULL CHECK (age > 0),
    gender ENUM("MALE", "FEMALE", "OTHERS") NOT NULL,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS address (
    address_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    address_unit VARCHAR(100) NOT NULL,
    address_street VARCHAR(50),
    address_town VARCHAR(30),
    address_state VARCHAR(30)
);

CREATE TABLE IF NOT EXISTS construction (
    construct_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    floor INT DEFAULT NULL,
    floors_in_building INT DEFAULT NULL,
    floor_area FLOAT DEFAULT NULL,
    ceiling_height FLOAT DEFAULT NULL,
    number_of_rooms INT DEFAULT NULL,
    number_of_bathrooms INT DEFAULT NULL,
    new_construction BOOLEAN DEFAULT FALSE,
    construction_type ENUM("STONE", "BRICKS", "PANELS", "WOODEN", "CASSETTE", "MONOLITH") DEFAULT NULL,
    type_balcony ENUM("OPEN", "MULTIPLE", "CLOSE", "NOT AVAILABLE") DEFAULT "NOT AVAILABLE",
    type_renovation ENUM("MAJOR", "COSMETIC", "DESIGNER", "MONOLITH", "EURO", "OLD", "PARTIAL", "NONE") DEFAULT "NONE",
    has_furniture ENUM("FURNITURED", "NON-FURNITURED", "BY AGREEMENT", "NONE") DEFAULT "NONE",
    has_elevator BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS criteria (
    criteria_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    allowed_children BOOLEAN,
    allowed_pets BOOLEAN
);

CREATE TABLE IF NOT EXISTS amenities (
    amenities_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    has_air_conditioner BOOLEAN DEFAULT FALSE,
    has_parking_space BOOLEAN DEFAULT FALSE,
    has_fridge BOOLEAN DEFAULT FALSE,
    has_internet BOOLEAN DEFAULT FALSE,
    has_television BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS appliance (
    appliance_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    has_washer BOOLEAN DEFAULT FALSE,
    has_dryer BOOLEAN DEFAULT FALSE,
    has_dishwasher BOOLEAN DEFAULT FALSE,
    has_microwave BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS parking (
    parking_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    has_covered BOOLEAN DEFAULT FALSE,
    has_garage BOOLEAN DEFAULT FALSE,
    has_outdoor BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS property (
    property_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    address_id INT NOT NULL,
    construct_id INT NOT NULL,
    criteria_id INT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (address_id) REFERENCES address(address_id),
    FOREIGN KEY (construct_id) REFERENCES construction(construct_id),
    FOREIGN KEY (criteria_id) REFERENCES criteria(criteria_id)
);

CREATE TABLE IF NOT EXISTS property_amenities (
    property_id INT,
    amenities_id INT,
    PRIMARY KEY (property_id, amenities_id),
    FOREIGN KEY (property_id) REFERENCES property(property_id),
    FOREIGN KEY (amenities_id) REFERENCES amenities(amenities_id)
);

CREATE TABLE IF NOT EXISTS property_appliance (
    property_id INT,
    appliance_id INT,
    PRIMARY KEY (property_id, appliance_id),
    FOREIGN KEY (property_id) REFERENCES property(property_id),
    FOREIGN KEY (appliance_id) REFERENCES appliance(appliance_id)
);

CREATE TABLE IF NOT EXISTS property_parking (
    property_id INT,
    parking_id INT,
    PRIMARY KEY (property_id, parking_id),
    FOREIGN KEY (property_id) REFERENCES property(property_id),
    FOREIGN KEY (parking_id) REFERENCES parking(parking_id)
);

CREATE TABLE IF NOT EXISTS tenant_property (
    rental_id INT PRIMARY KEY AUTO_INCREMENT UNIQUE,
    tenant_id INT NOT NULL,
    property_id INT NOT NULL,
    purge_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    duration ENUM("DAILY", "WEEKLY", "MONTHLY", "ANNUALLY"),
    price FLOAT NOT NULL,
    currency ENUM("AMD", "EUR", "GBP", "USD"),
    type_utility_payments VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    FOREIGN KEY (property_id) REFERENCES property(property_id)
);

-- B. Insert sample entries for testing (selected 10 entries, or slightly amended)

INSERT INTO tenant 
	(age, gender) 
		VALUES
		(60, "MALE"),(51, "FEMALE"),(20, "MALE"),(57, "FEMALE"),(43, "FEMALE"),
		(54, "MALE"),(61, "FEMALE"),(32, "MALE"),(52, "MALE"),(32, "FEMALE");

INSERT INTO address 
	(address_unit, address_street, address_town, address_state) 
		VALUES
			("Ararat ‚Ä∫ Artashat", NULL, "Artashat", "Ararat"),
			("Armavir ‚Ä∫ Echmiadzin", NULL, "Echmiadzin", "Armavir"),
			("Lernagorts Street, Vardenis", "Lernagorts Street", "Vardenis", NULL),
			("Antarayin 1st blok 10, Tsaghkadzor", "Antarayin 1st blok 10", "Tsaghkadzor", NULL),
			("13th street, Gyumri", "13th street", "Gyumri", NULL),
			("Tavush ‚Ä∫ Dilijan", NULL, "Dilijan", "Tavush"),
			("Aram Street 107, Yerevan", "Aram Street 107", "Yerevan", NULL),
			("Sayat Nova avenue, Yerevan", "Sayat Nova avenue", "Yerevan", NULL);

INSERT INTO construction 
    (floor, floors_in_building, floor_area, ceiling_height, number_of_rooms, number_of_bathrooms,
    new_construction, construction_type, type_balcony, type_renovation, has_furniture, has_elevator)
		VALUES
			(5, 5, 41, 270, 2, 1, FALSE, "STONE", "OPEN", "MAJOR", NULL, FALSE),
			(4, 5, 76, 270, 4, 1, FALSE, "STONE", "OPEN", "EURO", NULL, FALSE),
			(3, 5, 78, 270, 3, 1, FALSE, "STONE", "CLOSE", "MAJOR", "FURNITURED", FALSE),
			(NULL, 1, NULL, 0, 0, 0, FALSE, NULL, NULL, NULL, NULL, FALSE),
			(9, 12, 40, 250, 1, 1, TRUE, "STONE", "OPEN", "EURO", NULL, TRUE),
			(NULL, 12, NULL, NULL, NULL, NULL, TRUE, "MONOLITH", NULL, NULL, NULL, TRUE),
			(3, 4, 100, 260, 3, 1, FALSE, "BRICKS", "OPEN", "COSMETIC", NULL, FALSE),
			(2, 5, 70, 0, 3, 0, FALSE, "STONE", NULL, NULL, NULL, FALSE),
			(16, 18, 55, 300, 2, 1, TRUE, "MONOLITH", "OPEN", "DESIGNER", NULL, TRUE),
			(8, 9, 70, 280, 2, 1, FALSE, "PANELS", "CLOSE", "MAJOR", NULL, TRUE);

INSERT INTO criteria 
	(allowed_children, allowed_pets) 
		VALUES
			(TRUE, TRUE),(TRUE, TRUE),(TRUE, TRUE),(FALSE, FALSE),
			(FALSE, FALSE),(FALSE, FALSE),(TRUE, TRUE),(TRUE, TRUE),(TRUE, TRUE),(TRUE, FALSE);

INSERT INTO amenities 
	(has_air_conditioner, has_parking_space, has_fridge, has_internet, has_television) 
		VALUES
			(FALSE, FALSE, FALSE, FALSE, FALSE);

INSERT INTO appliance 
	(has_washer, has_dryer, has_dishwasher, has_microwave) 
		VALUES
			(FALSE, FALSE, FALSE, FALSE);

INSERT INTO parking 
	(has_covered, has_garage, has_outdoor) 
		VALUES
			(FALSE, FALSE, FALSE);

INSERT INTO property 
	(address_id, construct_id, criteria_id, is_active) 
		VALUES
		(1, 1, 1, TRUE), (2, 2, 2, TRUE), (2, 3, 3, TRUE), (3, 4, 4, TRUE), (4, 5, 5, TRUE),
		(4, 6, 6, TRUE), (5, 7, 7, TRUE), (6, 8, 8, TRUE), (7, 9, 9, TRUE), (8,10,10, TRUE);

INSERT INTO property_amenities
	(property_id, amenities_id) 
		VALUES
			(1, 1),(2, 1),(3, 1),(4, 1),(5, 1),(6, 1),(7, 1),(8, 1),(9, 1),(10, 1);

INSERT INTO property_appliance 
	(property_id, appliance_id) 
		VALUES
			(1, 1),(2, 1),(3, 1),(4, 1),(5, 1),(6, 1),(7, 1),(8, 1),(9, 1),(10, 1);

INSERT INTO property_parking 
	(property_id, parking_id) 
		VALUES
			(1, 1),(2, 1),(3, 1),(4, 1),(5, 1),(6, 1),(7, 1),(8, 1),(9, 1),(10, 1);

INSERT INTO tenant_property
	(tenant_id, property_id, purge_date, duration, price, currency, type_utility_payments) 
		VALUES
			(1, 1, NOW(), "MONTHLY", 1200, "USD", "ALL"),
			(2, 2, NOW(), "MONTHLY", 1300, "USD", "ALL"),
			(3, 3, NOW(), "MONTHLY", 1100, "USD", "ALL"),
			(4, 4, NOW(), "MONTHLY", 1050, "USD", "ALL"),
			(5, 5, NOW(), "MONTHLY", 1500, "USD", "ALL"),
			(6, 6, NOW(), "MONTHLY", 1000, "USD", "ALL"),
			(7, 7, NOW(), "MONTHLY", 1800, "USD", "ALL"),
			(8, 8, NOW(), "MONTHLY", 1400, "USD", "ALL"),
			(9, 9, NOW(), "MONTHLY", 1250, "USD", "ALL"),
			(10, 10, NOW(), "MONTHLY", 1350, "USD", "ALL");
            
            
            
--  QUESTION 2b(i)
--  remarks:  choose 1 record from csv, and insert the data to table 

INSERT INTO tenant 
	(age, gender) 
		VALUES 
			(31, "FEMALE");
SET @tenant_id = LAST_INSERT_ID();

INSERT INTO address 
	(address_unit, address_town) 
		VALUES 
			("Davidashen 4-th block, Yerevan", "Yerevan");
SET @address_id = LAST_INSERT_ID();

INSERT INTO construction 
	(construction_type, new_construction, has_elevator, floors_in_building, floor_area,
    number_of_rooms, number_of_bathrooms, ceiling_height, floor, type_balcony,
    has_furniture, type_renovation) 
		VALUES 
			("MONOLITH", TRUE, TRUE, 9, 85,3, 1, 3, 4, "OPEN",NULL, "EURO");
SET @construction_id = LAST_INSERT_ID();

INSERT INTO criteria 
	(allowed_children, allowed_pets) 
		VALUES 
			(TRUE, TRUE);
SET @criteria_id = LAST_INSERT_ID();

INSERT INTO property 
	(address_id, construct_id, criteria_id, is_active)
		VALUES 
			(@address_id, @construction_id, @criteria_id, TRUE);
SET @property_id = LAST_INSERT_ID();

INSERT INTO tenant_property 
	(tenant_id, property_id, purge_date, duration, price, currency, type_utility_payments, is_active)
		VALUES 
		(@tenant_id, @property_id, STR_TO_DATE("07/01/2023", "%m/%d/%Y"), "MONTHLY", 1100, "USD", NULL, TRUE);

INSERT INTO amenities 
	(has_air_conditioner, has_parking_space, has_fridge, has_internet, has_television)
		VALUES 
			(FALSE, FALSE, FALSE, FALSE, FALSE);
SET @amenities_id = LAST_INSERT_ID();

INSERT INTO appliance
	(has_washer, has_dryer, has_dishwasher, has_microwave)
		VALUES 
			(FALSE, FALSE, FALSE, FALSE);
SET @appliance_id = LAST_INSERT_ID();

INSERT INTO parking 
	(has_covered, has_garage, has_outdoor)
		VALUES 
			(FALSE, FALSE, FALSE);
SET @parking_id = LAST_INSERT_ID();

INSERT INTO property_amenities (property_id, amenities_id) VALUES (@property_id, @amenities_id);

INSERT INTO property_appliance (property_id, appliance_id) VALUES (@property_id, @appliance_id );

INSERT INTO property_parking (property_id, parking_id) VALUES (@property_id, @parking_id);

-- SELECT * FROM tenant_property;


--  QUESTION 2b(ii) 
SELECT 
	property.property_id, address.address_unit, address.address_street,address.address_town, 
	address.address_state, tenant_property.price, tenant_property.currency, construction.has_elevator
		FROM property
			JOIN address ON property.address_id = address.address_id
			JOIN construction ON property.construct_id = construction.construct_id
			JOIN tenant_property ON property.property_id = tenant_property.property_id
				WHERE 
					tenant_property.price <= 1000
						AND construction.has_elevator = TRUE
						AND tenant_property.currency = "USD"
						AND tenant_property.is_active = TRUE
						AND property.is_active = TRUE;

-- SELECT * FROM tenant_property;


--  QUESTION 2b(iii) 

SELECT currency, ROUND(AVG(price), 2) AS average_price
	FROM tenant_property
		WHERE is_active = TRUE
			GROUP BY currency
				ORDER BY average_price DESC;
                

                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               